<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>XOXO ‚Äî Multiplayer Tic-Tac-Toe</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #faf7f2;           /* —Ç—ë–ø–ª—ã–π –±–µ–ª—ã–π —Ñ–æ–Ω */
    --surface: #ffffff;       /* —á–∏—Å—Ç—ã–π –±–µ–ª—ã–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
    --surface2: #fff9f0;     /* –∫—Ä–µ–º–æ–≤—ã–π –æ—Ç—Ç–µ–Ω–æ–∫ */
    --border: #e6dfd3;       /* –ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–π –±–µ–∂–µ–≤—ã–π */
    --accent: #c9a02e;       /* –ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω–æ–µ –∑–æ–ª–æ—Ç–æ */
    --accent2: #b38b2c;      /* –±–æ–ª–µ–µ —Ç—ë–º–Ω–æ–µ –∑–æ–ª–æ—Ç–æ */
    --accent3: #e6b422;      /* —è—Ä–∫–æ–µ –∑–æ–ª–æ—Ç–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π */
    --text: #3a3a3a;         /* —Ç—ë–º–Ω–æ-—Å–µ—Ä—ã–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
    --text-dim: #7a7a7a;     /* —Å–µ—Ä—ã–π –¥–ª—è –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ */
    --x-color: #b38b2c;      /* –∑–æ–ª–æ—Ç–æ –¥–ª—è X */
    --o-color: #5a5a5a;      /* —Ç—ë–º–Ω—ã–π –≥—Ä–∞—Ñ–∏—Ç –¥–ª—è O */
    --glow-x: 0 0 30px rgba(201, 160, 46, 0.25);
    --glow-o: 0 0 30px rgba(90, 90, 90, 0.2);
    --glow-accent: 0 0 40px rgba(201, 160, 46, 0.3);
    --radius: 16px;
    --font-head: 'Syne', sans-serif;
    --font-mono: 'Space Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-head);
    min-height: 100vh;
    overflow-x: hidden;
  }

  .bg-grid {
    position: fixed; inset: 0; z-index: 0;
    background-image: 
      linear-gradient(rgba(201, 160, 46, 0.05) 1px, transparent 1px),
      linear-gradient(90deg, rgba(201, 160, 46, 0.05) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none;
  }

  .bg-blob {
    position: fixed; border-radius: 50%;
    filter: blur(80px); pointer-events: none; z-index: 0;
    animation: blobFloat 8s ease-in-out infinite;
  }
  .bg-blob-1 {
    width: 500px; height: 500px;
    background: rgba(230, 180, 34, 0.06);
    top: -200px; left: -100px;
  }
  .bg-blob-2 {
    width: 400px; height: 400px;
    background: rgba(179, 139, 44, 0.04);
    bottom: -150px; right: -100px;
    animation-delay: -4s;
  }
  .bg-blob-3 {
    width: 300px; height: 300px;
    background: rgba(201, 160, 46, 0.03);
    top: 40%; left: 50%;
    animation-delay: -2s;
  }

  @keyframes blobFloat {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(20px, -30px) scale(1.05); }
    66% { transform: translate(-15px, 20px) scale(0.95); }
  }

  #app { position: relative; z-index: 1; min-height: 100vh; }

  .screen {
    display: none; min-height: 100vh;
    align-items: center; justify-content: center;
    padding: 24px;
    animation: screenIn 0.5s ease;
  }
  .screen.active { display: flex; }
  @keyframes screenIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .logo {
    font-size: clamp(48px, 10vw, 80px);
    font-weight: 800;
    letter-spacing: -3px;
    line-height: 1;
    background: linear-gradient(135deg, #b38b2c, #c9a02e, #e6b422);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-align: center;
  }

  .tagline {
    color: var(--text-dim);
    font-family: var(--font-mono);
    font-size: 12px;
    text-align: center;
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-top: 8px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 32px;
    width: 100%;
    max-width: 480px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.02);
  }
  .card-title {
    font-size: 20px; font-weight: 700;
    margin-bottom: 24px; color: var(--text);
  }

  .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
  .input-label { font-size: 11px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim); }
  .input {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    color: var(--text);
    font-family: var(--font-head);
    font-size: 16px;
    font-weight: 600;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    width: 100%;
  }
  .input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(201, 160, 46, 0.15);
  }
  .input::placeholder { color: var(--text-dim); font-weight: 400; }

  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 14px 28px; border-radius: 10px;
    font-family: var(--font-head); font-size: 15px; font-weight: 700;
    cursor: pointer; border: none; transition: all 0.2s;
    text-transform: uppercase; letter-spacing: 1px;
  }
  .btn-primary {
    background: var(--accent);
    color: white;
    box-shadow: 0 4px 20px rgba(201, 160, 46, 0.35);
  }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(201, 160, 46, 0.5); }
  .btn-primary:active { transform: translateY(0); }

  .btn-ghost {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--text); }

  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
  .btn-full { width: 100%; }

  #lobby-screen .container {
    width: 100%; max-width: 900px;
  }
  .lobby-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 32px; flex-wrap: wrap; gap: 16px;
  }
  .user-pill {
    display: flex; align-items: center; gap: 10px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 100px; padding: 8px 16px 8px 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.02);
  }
  .avatar {
    width: 36px; height: 36px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 800;
    color: white;
  }
  .user-pill .username { font-size: 14px; font-weight: 600; color: var(--text); }

  .lobby-grid {
    display: grid; grid-template-columns: 1fr 2fr; gap: 20px;
  }
  @media (max-width: 700px) { .lobby-grid { grid-template-columns: 1fr; } }

  .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 16px; }
  .stat-item {
    background: var(--surface2); border-radius: 12px; padding: 16px 12px;
    text-align: center;
    border: 1px solid var(--border);
  }
  .stat-number { font-size: 28px; font-weight: 800; line-height: 1; }
  .stat-label { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-dim); margin-top: 4px; }
  .stat-wins .stat-number { color: var(--accent); }
  .stat-losses .stat-number { color: var(--o-color); }
  .stat-draws .stat-number { color: var(--accent2); }

  .sessions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
  .sessions-header h2 { font-size: 16px; font-weight: 700; color: var(--text); }
  .live-dot {
    display: inline-flex; align-items: center; gap: 6px;
    font-family: var(--font-mono); font-size: 11px; color: var(--accent);
  }
  .live-dot::before {
    content: ''; width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent);
    animation: pulse 1.5s ease-in-out infinite;
  }
  @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }

  .sessions-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }

  .session-card {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px;
    display: flex; align-items: center; justify-content: space-between;
    transition: all 0.2s; cursor: pointer;
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
  .session-card:hover { border-color: var(--accent); transform: translateX(4px); }

  .session-info .session-name { font-size: 15px; font-weight: 700; color: var(--text); }
  .session-info .session-meta { font-size: 12px; color: var(--text-dim); margin-top: 2px; font-family: var(--font-mono); }
  .session-badge {
    padding: 4px 10px; border-radius: 100px; font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
  }
  .badge-waiting { background: rgba(201, 160, 46, 0.12); color: var(--accent); border: 1px solid rgba(201, 160, 46, 0.3); }
  .badge-playing { background: rgba(90, 90, 90, 0.1); color: var(--o-color); border: 1px solid rgba(90, 90, 90, 0.2); }

  .empty-state {
    text-align: center; padding: 48px 24px;
    color: var(--text-dim); font-family: var(--font-mono); font-size: 13px;
  }
  .empty-state .emoji { font-size: 36px; display: block; margin-bottom: 12px; }

  #game-screen {
    flex-direction: column;
    padding: 16px;
  }
  .game-container { width: 100%; max-width: 600px; }

  .game-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 24px;
  }

  .players-bar {
    display: grid; grid-template-columns: 1fr auto 1fr;
    gap: 12px; align-items: center;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.02);
  }
  .player-slot {
    display: flex; flex-direction: column; gap: 4px;
  }
  .player-slot.right { align-items: flex-end; text-align: right; }
  .player-symbol {
    font-size: 24px; font-weight: 800;
    font-family: var(--font-mono);
    line-height: 1;
  }
  .player-symbol.x { color: var(--x-color); text-shadow: var(--glow-x); }
  .player-symbol.o { color: var(--o-color); text-shadow: var(--glow-o); }
  .player-name { font-size: 14px; font-weight: 700; color: var(--text); }
  .player-score { font-size: 12px; color: var(--text-dim); font-family: var(--font-mono); }
  .player-slot.active .player-name::before {
    content: '‚ñ∂ '; color: var(--accent); font-size: 10px;
  }
  .player-slot.active.right .player-name::before { content: ''; }
  .player-slot.active.right .player-name::after { content: ' ‚óÄ'; color: var(--accent); font-size: 10px; }

  .vs-divider { font-family: var(--font-mono); font-size: 14px; color: var(--text-dim); text-align: center; }

  .status-bar {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 20px;
    text-align: center; font-family: var(--font-mono); font-size: 13px;
    margin-bottom: 20px; color: var(--text-dim);
    min-height: 44px; display: flex; align-items: center; justify-content: center;
  }
  .status-bar.your-turn { border-color: var(--accent); color: var(--accent); background: rgba(201, 160, 46, 0.06); }
  .status-bar.win { border-color: var(--accent); color: var(--accent); background: rgba(201, 160, 46, 0.06); }
  .status-bar.loss { border-color: var(--o-color); color: var(--o-color); background: rgba(90, 90, 90, 0.06); }
  .status-bar.draw { border-color: var(--accent2); color: var(--text); }

  .board-wrapper {
    position: relative; margin-bottom: 20px;
  }
  .board {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 10px; 
  }
  .cell {
    aspect-ratio: 1; border-radius: 14px;
    background: var(--surface); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: clamp(40px, 10vw, 72px);
    font-family: var(--font-mono); font-weight: 700;
    transition: all 0.15s; position: relative; overflow: hidden;
    user-select: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.02);
  }
  .cell::before {
    content: ''; position: absolute; inset: 0;
    background: var(--accent); opacity: 0;
    transition: opacity 0.15s;
  }
  .cell:hover:not(.taken):not(.disabled)::before { opacity: 0.06; }
  .cell:hover:not(.taken):not(.disabled) { border-color: var(--accent); transform: scale(0.97); }
  .cell.taken { cursor: default; }
  .cell.disabled { cursor: not-allowed; }

  .cell .symbol {
    position: relative; z-index: 1;
    animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  @keyframes popIn {
    from { transform: scale(0) rotate(-15deg); opacity: 0; }
    to { transform: scale(1) rotate(0deg); opacity: 1; }
  }
  .cell.x .symbol { color: var(--x-color); text-shadow: var(--glow-x); }
  .cell.o .symbol { color: var(--o-color); text-shadow: var(--glow-o); }
  .cell.win-cell { animation: winPulse 0.6s ease forwards; }
  @keyframes winPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.08); }
    100% { transform: scale(1); }
  }
  .cell.x.win-cell { background: rgba(201, 160, 46, 0.08); border-color: var(--x-color); }
  .cell.o.win-cell { background: rgba(90, 90, 90, 0.08); border-color: var(--o-color); }

  .game-over-overlay {
    display: none; position: absolute; inset: 0;
    background: rgba(250, 247, 242, 0.9); backdrop-filter: blur(8px);
    border-radius: 14px; z-index: 10;
    align-items: center; justify-content: center;
    flex-direction: column; gap: 16px;
    animation: fadeIn 0.4s ease;
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .game-over-overlay.show { display: flex; }
  .game-over-emoji { font-size: 56px; animation: bounceIn 0.6s cubic-bezier(0.34,1.56,0.64,1); }
  @keyframes bounceIn {
    from { transform: scale(0) rotate(-20deg); }
    to { transform: scale(1) rotate(0deg); }
  }
  .game-over-text { font-size: 28px; font-weight: 800; text-align: center; color: var(--text); }
  .game-over-sub { font-size: 14px; color: var(--text-dim); font-family: var(--font-mono); }

  .game-actions { display: flex; gap: 10px; }

  .waiting-overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(250, 247, 242, 0.95); backdrop-filter: blur(12px);
    display: none; align-items: center; justify-content: center;
    flex-direction: column; gap: 20px;
  }
  .waiting-overlay.show { display: flex; }
  .spinner {
    width: 48px; height: 48px; border: 3px solid var(--border);
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .waiting-text { font-size: 20px; font-weight: 700; color: var(--text); }
  .waiting-sub { font-family: var(--font-mono); font-size: 13px; color: var(--text-dim); }
  .session-code {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 24px;
    font-family: var(--font-mono); font-size: 20px; font-weight: 700;
    letter-spacing: 4px; color: var(--accent);
  }

  .toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 12px 18px;
    font-size: 14px; font-weight: 600;
    animation: toastIn 0.3s ease;
    max-width: 280px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  @keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
  @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(20px); } }
  .toast.success { border-color: var(--accent); color: var(--accent); }
  .toast.error { border-color: var(--o-color); color: var(--o-color); }
  .toast.info { border-color: var(--accent2); color: var(--accent2); }

  .grow { flex: 1; }
</style>
</head>
<body>

<div class="bg-grid"></div>
<div class="bg-blob bg-blob-1"></div>
<div class="bg-blob bg-blob-2"></div>
<div class="bg-blob bg-blob-3"></div>

<div class="toast-container" id="toastContainer"></div>

<div id="enter-screen" class="screen active">
  <div style="width:100%; max-width:420px; display:flex; flex-direction:column; gap:24px;">
    <div>
      <div class="logo">XOXO</div>
      <div class="tagline">Real-time multiplayer tic-tac-toe</div>
    </div>

    <div class="card">
      <div class="card-title">Enter the arena</div>
      <div class="input-group">
        <div class="input-label">Your name</div>
        <input type="text" id="name-input" class="input" placeholder="e.g. Alex, Darkwing, œÄ" maxlength="20" autocomplete="off">
      </div>
      <button class="btn btn-primary btn-full" id="enter-btn">
        <span>Play Now</span>
        <span>‚Üí</span>
      </button>
      <div style="text-align:center; margin-top:16px; font-size:12px; color:var(--text-dim); font-family:var(--font-mono);">
        No registration. Just play.
      </div>
    </div>

    <div style="text-align:center;">
      <div style="font-size:12px; color:var(--text-dim); font-family:var(--font-mono);">
        ‚ö° Live ¬∑ Multiple concurrent games ¬∑ Stats tracking
      </div>
    </div>
  </div>
</div>

<div id="lobby-screen" class="screen">
  <div class="container">
    <div class="lobby-header">
      <div>
        <div class="logo" style="font-size:36px; letter-spacing:-2px;">XOXO</div>
      </div>
      <div class="user-pill">
        <div class="avatar" id="lobby-avatar" style="background: var(--accent);">A</div>
        <div class="username" id="lobby-username">Player</div>
        <button class="btn btn-ghost" style="padding:6px 10px; font-size:12px;" id="logout-btn">‚Üê Exit</button>
      </div>
    </div>

    <div class="lobby-grid">
      <div style="display:flex; flex-direction:column; gap:16px;">
        <div class="card">
          <div class="card-title" style="margin-bottom:8px;">Your Stats</div>
          <div class="stats-grid">
            <div class="stat-item stat-wins">
              <div class="stat-number" id="stat-wins">0</div>
              <div class="stat-label">Wins</div>
            </div>
            <div class="stat-item stat-losses">
              <div class="stat-number" id="stat-losses">0</div>
              <div class="stat-label">Losses</div>
            </div>
            <div class="stat-item stat-draws">
              <div class="stat-number" id="stat-draws">0</div>
              <div class="stat-label">Draws</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Host a Game</div>
          <p style="font-size:13px; color:var(--text-dim); margin-bottom:16px; font-family:var(--font-mono); line-height:1.6;">
            Create a session and wait for an opponent to join.
          </p>
          <button class="btn btn-primary btn-full" id="create-game-btn">
            Ôºã Create Session
          </button>
        </div>
      </div>

      <div class="card">
        <div class="sessions-header">
          <h2>Open Games</h2>
          <div class="live-dot">LIVE</div>
        </div>
        <div id="sessions-list" class="sessions-list">
          <div class="empty-state">
            <span class="emoji">üéÆ</span>
            No open games yet.<br>Be the first to create one!
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="game-screen" class="screen">
  <div class="game-container">
    <div class="game-header">
      <button class="btn btn-ghost" id="leave-game-btn" style="padding:10px 16px; font-size:13px;">‚Üê Lobby</button>
      <div style="font-family:var(--font-mono); font-size:13px; color:var(--text-dim);" id="game-id-label">#session</div>
    </div>

    <div class="players-bar" id="players-bar">
      <div class="player-slot left" id="player-x-slot">
        <div class="player-symbol x">X</div>
        <div class="player-name" id="player-x-name">Waiting...</div>
        <div class="player-score" id="player-x-score">0</div>
      </div>
      <div class="vs-divider">VS</div>
      <div class="player-slot right" id="player-o-slot">
        <div class="player-symbol o">O</div>
        <div class="player-name" id="player-o-name">Waiting...</div>
        <div class="player-score" id="player-o-score">0</div>
      </div>
    </div>

    <div class="status-bar" id="status-bar">Waiting for opponent‚Ä¶</div>

    <div class="board-wrapper">
      <div class="board" id="board">
        <div class="cell" data-index="0"></div>
        <div class="cell" data-index="1"></div>
        <div class="cell" data-index="2"></div>
        <div class="cell" data-index="3"></div>
        <div class="cell" data-index="4"></div>
        <div class="cell" data-index="5"></div>
        <div class="cell" data-index="6"></div>
        <div class="cell" data-index="7"></div>
        <div class="cell" data-index="8"></div>
      </div>
      <div class="game-over-overlay" id="game-over-overlay">
        <div class="game-over-emoji" id="game-over-emoji">üéâ</div>
        <div class="game-over-text" id="game-over-text">You Win!</div>
        <div class="game-over-sub" id="game-over-sub">gg</div>
        <button class="btn btn-primary" id="rematch-btn">üîÅ Rematch</button>
      </div>
    </div>

    <div class="game-actions">
      <button class="btn btn-ghost grow" id="leave-game-btn2">‚Üê Back to Lobby</button>
    </div>
  </div>
</div>

<div class="waiting-overlay" id="waiting-overlay">
  <div class="spinner"></div>
  <div class="waiting-text">Waiting for opponent‚Ä¶</div>
  <div class="session-code" id="waiting-code">XXX</div>
  <div class="waiting-sub">Share your session name with a friend</div>
  <button class="btn btn-ghost" id="cancel-waiting-btn">Cancel</button>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, get, push, onValue, update, remove } 
  from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyAR4H67yRFYEvEXhK_Iiz9AMW0Ixe1Ah7k",
  authDomain: "task6-d7e08.firebaseapp.com",
  databaseURL: "https://task6-d7e08-default-rtdb.europe-west1.firebasedatabase.app", // ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û
  projectId: "task6-d7e08",
  storageBucket: "task6-d7e08.firebasestorage.app",
  messagingSenderId: "531246443100",
  appId: "1:531246443100:web:98a1d499ccbc1856fb9499"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const WIN_COMBOS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

let state = {
  screen: 'enter',
  playerName: '',
  stats: { wins: 0, losses: 0, draws: 0 },
  currentGame: null,
  sessionsListener: null,
  gameListener: null,
};

function $(id) { return document.getElementById(id); }

function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  $(`${name}-screen`).classList.add('active');
  state.screen = name;
}

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  $('toastContainer').appendChild(el);
  setTimeout(() => {
    el.style.animation = 'toastOut 0.3s ease forwards';
    setTimeout(() => el.remove(), 300);
  }, 3000);
}

function avatarColor(name) {
  const colors = ['#7c5cfc','#fc5c7d','#5cfcb4','#fca85c','#5cb4fc','#fc5cf0'];
  let h = 0;
  for (let c of name) h = (h * 31 + c.charCodeAt(0)) % colors.length;
  return colors[h];
}

function saveStats() {
  localStorage.setItem(`xoxo_stats_${state.playerName}`, JSON.stringify(state.stats));
}

function loadStats() {
  try { 
    state.stats = JSON.parse(localStorage.getItem(`xoxo_stats_${state.playerName}`)) || { wins:0,losses:0,draws:0 }; 
  } catch { 
    state.stats = { wins:0,losses:0,draws:0 }; 
  }
}

function updateStatsUI() {
  $('stat-wins').textContent = state.stats.wins;
  $('stat-losses').textContent = state.stats.losses;
  $('stat-draws').textContent = state.stats.draws;
}

function checkWinner(board) {
  for (const [a,b,c] of WIN_COMBOS) {
    if (board[a] && board[a] === board[b] && board[a] === board[c])
      return { winner: board[a], combo: [a,b,c] };
  }
  if (board.every(c => c)) return { winner: 'draw', combo: [] };
  return null;
}

function enterLobby() {
  $('lobby-avatar').textContent = state.playerName[0].toUpperCase();
  $('lobby-avatar').style.background = avatarColor(state.playerName);
  $('lobby-username').textContent = state.playerName;
  loadStats(); 
  updateStatsUI();
  showScreen('lobby');

  if (state.sessionsListener) state.sessionsListener();
  state.sessionsListener = onValue(ref(db, 'sessions'), snap => {
    renderSessions(snap.val() || {});
  });
}

function renderSessions(sessions) {
  const list = $('sessions-list');
  const waiting = Object.entries(sessions).filter(([,s]) => s.status === 'waiting' && s.hostName !== state.playerName);
  const mySession = Object.entries(sessions).find(([,s]) => s.hostName === state.playerName && s.status === 'waiting');

  let html = '';

  if (mySession) {
    html += `<div class="session-card" style="border-color:var(--accent); background:rgba(124,92,252,0.08);">
      <div class="session-info">
        <div class="session-name">Your Session</div>
        <div class="session-meta">Waiting for opponent...</div>
      </div>
      <span class="session-badge badge-waiting">YOUR GAME</span>
    </div>`;
  }

  waiting.forEach(([id, session]) => {
    html += `<div class="session-card" data-id="${id}">
      <div class="session-info">
        <div class="session-name">${session.hostName}'s game</div>
        <div class="session-meta">Waiting ¬∑ #${id.slice(-4)}</div>
      </div>
      <span class="session-badge badge-waiting">JOIN ‚Üí</span>
    </div>`;
  });

  const playing = Object.entries(sessions).filter(([,s]) => s.status === 'playing');
  playing.forEach(([id, session]) => {
    html += `<div class="session-card" style="opacity:0.5; cursor:default;">
      <div class="session-info">
        <div class="session-name">${session.hostName} vs ${session.guestName}</div>
        <div class="session-meta">In progress ¬∑ #${id.slice(-4)}</div>
      </div>
      <span class="session-badge badge-playing">IN PLAY</span>
    </div>`;
  });

  list.innerHTML = html || `<div class="empty-state"><span class="emoji">üéÆ</span>No open games yet.<br>Be the first to create one!</div>`;

  document.querySelectorAll('.session-card[data-id]').forEach(card => {
    card.addEventListener('click', () => joinGame(card.dataset.id));
  });
}

async function createGame() {
  try {
    const sessRef = push(ref(db, 'sessions'));
    const gameId = sessRef.key;

    await set(sessRef, {
      hostName: state.playerName,
      guestName: null,
      status: 'waiting',
      board: Array(9).fill(''),
      currentTurn: 'X',
      createdAt: Date.now(),
      scores: { X: 0, O: 0 },
    });

    state.currentGame = { id: gameId, role: 'host', symbol: 'X' };

    $('waiting-code').textContent = state.playerName + "'s game";
    $('waiting-overlay').classList.add('show');

    if (state.gameListener) state.gameListener();
    state.gameListener = onValue(ref(db, `sessions/${gameId}`), snap => {
      const data = snap.val();
      if (!data) return;
      if (data.status === 'playing' && data.guestName) {
        $('waiting-overlay').classList.remove('show');
        state.gameListener();
        enterGame(gameId, data);
      }
    });

    toast('Session created!', 'success');
  } catch(err) {
    console.error(err);
    toast('Error: ' + err.message, 'error');
  }
}

async function joinGame(gameId) {
  try {
    const snap = await get(ref(db, `sessions/${gameId}`));
    const data = snap.val();
    
    if (!data || data.status !== 'waiting') {
      toast('Session unavailable', 'error'); 
      return;
    }
    if (data.hostName === state.playerName) {
      toast("That's your session!", 'error'); 
      return;
    }

    await update(ref(db, `sessions/${gameId}`), {
      guestName: state.playerName,
      status: 'playing',
    });

    state.currentGame = { id: gameId, role: 'guest', symbol: 'O' };
    enterGame(gameId, { ...data, guestName: state.playerName, status: 'playing' });
    toast(`Joined ${data.hostName}'s game!`, 'success');
  } catch(err) {
    console.error(err);
    toast('Error: ' + err.message, 'error');
  }
}

function enterGame(gameId, initialData) {
  const mySymbol = state.currentGame.symbol;
  showScreen('game');
  $('game-id-label').textContent = `#${gameId.slice(-6)}`;
  renderGameState(initialData, mySymbol);

  if (state.gameListener) state.gameListener();
  state.gameListener = onValue(ref(db, `sessions/${gameId}`), snap => {
    const data = snap.val();
    if (!data) { leaveGame(); return; }
    renderGameState(data, mySymbol);
  });
}

function renderGameState(data, mySymbol) {
  const xName = data.hostName || '?';
  const oName = data.guestName || 'Waiting‚Ä¶';
  $('player-x-name').textContent = xName;
  $('player-o-name').textContent = oName;
  $('player-x-score').textContent = `${(data.scores||{}).X||0} pts`;
  $('player-o-score').textContent = `${(data.scores||{}).O||0} pts`;

  const board = data.board || Array(9).fill('');
  const cells = document.querySelectorAll('.cell');
  const result = checkWinner(board);
  const isMyTurn = data.currentTurn === mySymbol && data.status === 'playing' && !result;

  $('player-x-slot').className = 'player-slot left' + (data.currentTurn === 'X' && !result ? ' active' : '');
  $('player-o-slot').className = 'player-slot right' + (data.currentTurn === 'O' && !result ? ' active' : '');

  const sb = $('status-bar');
  sb.className = 'status-bar';
  if (data.status === 'waiting' || !data.guestName) {
    sb.textContent = 'Waiting for opponent‚Ä¶';
  } else if (result) {
    if (result.winner === 'draw') {
      sb.className += ' draw'; sb.textContent = "It's a draw!";
    } else if (result.winner === mySymbol) {
      sb.className += ' win'; sb.textContent = 'üèÜ You won!';
    } else {
      sb.className += ' loss'; sb.textContent = 'üòî Opponent won';
    }
  } else if (isMyTurn) {
    sb.className += ' your-turn'; sb.textContent = '‚ö° Your turn!';
  } else {
    sb.textContent = `Waiting for ${data.currentTurn === 'X' ? xName : oName}‚Ä¶`;
  }

  cells.forEach((cell, i) => {
    const val = board[i];
    cell.className = 'cell';
    cell.innerHTML = '';
    if (val) {
      cell.classList.add('taken', val.toLowerCase());
      const sym = document.createElement('span');
      sym.className = 'symbol';
      sym.textContent = val;
      cell.appendChild(sym);
      if (result && result.combo.includes(i)) cell.classList.add('win-cell');
    } else if (!isMyTurn || result) {
      cell.classList.add('disabled');
    }
    
    const newCell = cell.cloneNode(true);
    cell.parentNode.replaceChild(newCell, cell);
    
    if (!val && isMyTurn && !result) {
      newCell.addEventListener('click', () => makeMove(i, board));
    }
  });

  const overlay = $('game-over-overlay');
  if (result) {
    overlay.classList.add('show');
    if (result.winner === 'draw') {
      $('game-over-emoji').textContent = 'ü§ù';
      $('game-over-text').textContent = "Draw!";
      $('game-over-sub').textContent = 'Equal!';
    } else if (result.winner === mySymbol) {
      $('game-over-emoji').textContent = 'üèÜ';
      $('game-over-text').textContent = 'You Win!';
      $('game-over-sub').textContent = 'Great!';
    } else {
      $('game-over-emoji').textContent = 'üòû';
      $('game-over-text').textContent = 'You Lose';
      $('game-over-sub').textContent = 'Next time!';
    }

    const statsKey = `xoxo_counted_${state.currentGame.id}_${data.board.join('')}`;
    if (!sessionStorage.getItem(statsKey)) {
      sessionStorage.setItem(statsKey, '1');
      if (result.winner === 'draw') state.stats.draws++;
      else if (result.winner === mySymbol) state.stats.wins++;
      else state.stats.losses++;
      saveStats(); 
      updateStatsUI();
    }
  } else {
    overlay.classList.remove('show');
  }
}

async function makeMove(index, board) {
  const gameId = state.currentGame.id;
  const symbol = state.currentGame.symbol;
  const newBoard = [...board];
  newBoard[index] = symbol;
  const next = symbol === 'X' ? 'O' : 'X';

  try {
    await update(ref(db, `sessions/${gameId}`), {
      board: newBoard,
      currentTurn: next,
    });
  } catch(err) {
    console.error(err);
    toast('Error making move', 'error');
  }
}

async function requestRematch() {
  try {
    await update(ref(db, `sessions/${state.currentGame.id}`), {
      board: Array(9).fill(''),
      currentTurn: 'X',
      status: 'playing',
    });
    $('game-over-overlay').classList.remove('show');
    toast('New round!', 'success');
  } catch(err) {
    console.error(err);
  }
}

function leaveGame() {
  if (state.gameListener) { 
    state.gameListener(); 
    state.gameListener = null; 
  }
  if (state.currentGame) {
    const gameId = state.currentGame.id;
    if (state.currentGame.role === 'host') {
      get(ref(db, `sessions/${gameId}`)).then(snap => {
        if (snap.val()) remove(ref(db, `sessions/${gameId}`));
      });
    }
    state.currentGame = null;
  }
  $('game-over-overlay').classList.remove('show');
  enterLobby();
}

$('enter-btn').addEventListener('click', () => {
  const name = $('name-input').value.trim();
  if (!name || name.length < 2) { 
    toast('Enter a name (min 2 chars)', 'error'); 
    return; 
  }
  state.playerName = name;
  enterLobby();
});

$('name-input').addEventListener('keydown', e => { 
  if (e.key === 'Enter') $('enter-btn').click(); 
});

$('logout-btn').addEventListener('click', () => {
  if (state.sessionsListener) { 
    state.sessionsListener(); 
    state.sessionsListener = null; 
  }
  showScreen('enter');
  $('name-input').value = '';
  toast('See you!', 'info');
});

$('create-game-btn').addEventListener('click', createGame);

$('cancel-waiting-btn').addEventListener('click', () => {
  if (state.currentGame) {
    remove(ref(db, `sessions/${state.currentGame.id}`));
    state.currentGame = null;
  }
  $('waiting-overlay').classList.remove('show');
  if (state.gameListener) { 
    state.gameListener(); 
    state.gameListener = null; 
  }
});

$('leave-game-btn').addEventListener('click', leaveGame);
$('leave-game-btn2').addEventListener('click', leaveGame);
$('rematch-btn').addEventListener('click', requestRematch);

console.log('üéÆ XOXO Ready!');
</script>
</body>
</html>
